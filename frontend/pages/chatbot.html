<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CLASSMATE AI - Chatbot Interface</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --bg-primary: #ffffff;            /* Main background */
      --bg-secondary: #f5f5f5;          /* Sidebar/Header/Footer background */
      --bg-tertiary: #eaeaea;           /* Chat bubbles or tertiary areas */
      --text-primary: #1a1a1a;          /* Main text color */
      --text-secondary: #555555;        /* Secondary text */
      --accent-primary: #005ad7;        /* Primary accent (e.g., buttons) */
      --accent-secondary: #008cba;      /* Secondary accent (e.g., hover or action) */
      --border-color: #cccccc;          /* Border and outlines */
      --font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --border-radius: 8px;
      --sidebar-width: 280px;
      --sidebar-width-collapsed: 0px;
      --header-height: 60px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      transition: width 0.3s ease, padding 0.3s ease, left 0.3s ease, opacity 0.3s ease;
      overflow-x: hidden; 
      opacity: 1;
      z-index: 1010; /* Ensure sidebar is above other content */
    }
    .sidebar.collapsed {
        width: var(--sidebar-width-collapsed);
        padding: 1rem 0;
        border-right: none;
        opacity: 0;
        pointer-events: none; /* Prevent interaction when hidden */
    }

    .sidebar-header {
      padding-bottom: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-header h2 {
      font-size: 1.2rem;
      color: var(--text-primary);
      white-space: nowrap;
    }
    .sidebar-toggle-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
    }
    .new-chat-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background-color: var(--accent-primary);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        width: 100%;
        margin-bottom: 1rem;
        transition: background-color 0.2s;
        white-space: nowrap;
    }
    .new-chat-btn:hover {
        background-color: #6A40D8;
    }
    .chat-history-list {
        flex-grow: 1;
        overflow-y: auto;
        list-style: none;
        white-space: nowrap;
    }
    .chat-history-list li {
        padding: 0.6rem 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: calc(var(--border-radius) / 2);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 5px;
    }
    .chat-history-list li:hover {
        background-color: var(--bg-tertiary);
    }
    .chat-history-list li.active {
        background-color: var(--accent-primary);
        color: white;
    }
    .chat-history-list .chat-item-title {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-history-list .chat-item-actions button {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.9rem;
        padding: 2px 4px;
    }
    .chat-history-list li.active .chat-item-actions button {
        color: white;
    }
    .chat-history-list .delete-chat-btn:hover {
        color: #ff4d4d;
    }
    .chat-history-list .rename-chat-btn:hover {
        color: var(--accent-secondary);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden; 
      background-color: var(--bg-primary);
      transition: margin-left 0.3s ease;
      position: relative; /* Ensure proper stacking context */
      z-index: 1000; /* Lower than sidebar but higher than other elements */
    }

    .app-container.sidebar-hidden .main-content {
        margin-left: 0;
    }

    header {
      height: var(--header-height);
      padding: 0 1.5rem;
      background-color: #000000; /* Changed to black as requested */
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between; /* Changed to space-between for better alignment */
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      flex-shrink: 0;
      position: relative; /* For proper positioning of elements */
    }
    
    .header-left {
      display: flex;
      align-items: center;
    }
    
    .header-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-logo {
      height: 40px; /* Adjust based on your header height */
      max-width: 100%;
      display: block;
    }
    
    .header-right {
      display: flex;
      align-items: center;
    }
    
    .header-sidebar-toggle-btn, .menu-toggle {
        background: none;
        border: none;
        color: #ffffff; /* Changed to white for better contrast with black background */
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1001;
    }
    
    #chat-title-static {
        font-size: 1.2rem;
        font-weight: 600;
        display: none; /* Hide the text as we're using the logo instead */
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-container::-webkit-scrollbar { width: 8px; }
    .chat-container::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .chat-container::-webkit-scrollbar-thumb { background-color: var(--accent-primary); border-radius: var(--border-radius); border: 2px solid var(--bg-secondary); }

    .message { max-width: 75%; padding: 0.75rem 1rem; border-radius: var(--border-radius); line-height: 1.5; word-wrap: break-word; position: relative; }
    .user { align-self: flex-end; background-color: var(--accent-primary); color: #FFFFFF; border-bottom-right-radius: 0; }
    .user .chat-content { color: #FFFFFF; }
    .bot { align-self: flex-start; background-color: var(--bg-tertiary); color: var(--text-primary); border-bottom-left-radius: 0; padding-right: 35px; }
    .message .chat-content p:first-child { margin-top: 0; }
    .message .chat-content p:last-child { margin-bottom: 0; }
    .message pre { background-color: #282c34; padding: 1rem; border-radius: var(--border-radius); overflow-x: auto; margin: 0.5rem 0; position: relative; padding-right: 60px; }
    .message code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.9em; }
    .message .code-copy-btn-container { position: absolute; top: 8px; right: 8px; }
    .bot > .reply-copy-btn-container { position: absolute; top: 5px; right: 5px; z-index: 10; }
    .copy-btn { background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 0.3rem 0.6rem; border-radius: calc(var(--border-radius) / 2); cursor: pointer; font-size: 0.8em; transition: background-color 0.2s, color 0.2s; }
    .copy-btn:hover { background-color: var(--accent-primary); color: #FFFFFF; }
    .copy-btn:active { transform: scale(0.95); }
    .bot-reply-copy-btn { padding: 0.2rem 0.4rem; font-size: 0.7em; }

    /* Input bar styling to match the screenshot */
    .input-container {
      display: flex;
      flex-direction: column;
      padding: 1rem 1.5rem;
      background-color: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      width: 100%;
      position: relative;
      bottom: 0;
      left: 0;
      right: 0;
    }

    /* Options bar moved above input */
    .options-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px; /* Changed from margin-top to margin-bottom */
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    .option-button {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 0.9rem;
      color: var(--text-primary);
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s;
    }

    .option-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .option-button i {
      margin-right: 6px;
    }

    .option-button.active {
      background-color: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      background-color: white;
      border-radius: 24px;
      border: 1px solid var(--border-color);
      padding: 8px 16px;
      position: relative;
    }

    #user-input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 8px 0;
      font-family: var(--font-family);
      font-size: 1rem;
      resize: none;
      outline: none;
      max-height: calc(1.5em * 3);
      overflow-y: auto;
    }

    .input-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .input-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    #mic-button {
      color: var(--text-secondary);
    }

    #mic-button.recording {
      color: #ff4d4d;
    }

    #send-button {
      color: var(--accent-primary);
    }

    #send-button:disabled {
      color: var(--text-secondary);
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading-indicator { display: none; align-self: flex-start; margin-left: 1.5rem; margin-bottom: 1rem; }
    .loading-indicator span { display: inline-block; width: 8px; height: 8px; margin-right: 4px; border-radius: 50%; background-color: var(--text-secondary); animation: bounce 1.4s infinite ease-in-out both; }
    .loading-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .loading-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

    .bot .chat-content table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; display: block; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch}
    .bot .chat-content th, .bot .chat-content td { border: 1px solid var(--border-color); padding: 0.5rem 0.75rem; text-align: left; min-width: 100px;}
    .bot .chat-content th { background-color: var(--bg-tertiary); font-weight: 600; }
    .bot .chat-content ul, .bot .chat-content ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .bot .chat-content strong { font-weight: 600; }
    .bot .chat-content a { color: var(--accent-secondary); text-decoration: none; }
    .bot .chat-content a:hover { text-decoration: underline; }

    /* Mobile overlay for sidebar */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1005;
    }

    /* Responsive breakpoints - improved for all viewport sizes */
    @media (min-width: 1025px) {
      /* Large desktop */
      .sidebar {
        position: relative;
        left: 0;
      }
      .menu-toggle {
        display: none;
      }
      .header-sidebar-toggle-btn {
        display: block;
      }
      .sidebar-overlay {
        display: none !important;
      }
    }

    @media (max-width: 1024px) {
      /* Medium screens and below - treat like mobile */
      .sidebar {
        position: fixed;
        left: calc(-1 * var(--sidebar-width)); 
        top: 0;
        height: 100%;
        z-index: 1010;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        opacity: 1;
        pointer-events: auto;
        width: 85%; /* Slightly narrower on mobile */
        max-width: var(--sidebar-width);
      }
      
      .sidebar.open {
        left: 0;
      }
      
      .sidebar.open + .sidebar-overlay {
        display: block;
      }
      
      .sidebar.collapsed {
        left: calc(-1 * var(--sidebar-width)); 
        opacity: 0;
        pointer-events: none;
      }
      
      .menu-toggle {
        display: block; 
      }
      
      .header-sidebar-toggle-btn {
        display: none; 
      }
      
      .header-center {
        position: static;
        transform: none;
        flex-grow: 1;
        text-align: center;
      }
      
      header { 
        padding: 0 1rem; 
        justify-content: space-between;
      }
      
      .chat-container, .input-container { 
        padding: 1rem;
        width: 100%; 
      }

      .chat-container { 
        padding-bottom: 20px; /* Adjusted for input container */
      }
      
      .message { 
        max-width: 90%; 
      }
      
      .bot { 
        padding-right: 30px; 
      }
      
      .message pre { 
        padding-right: 50px; 
      }
      
      #user-input { 
        font-size: 0.95rem; 
      }
      
      /* Ensure options bar is visible */
      .options-bar {
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px; /* More padding for better touch */
        margin-bottom: 10px;
        scrollbar-width: none; /* Hide scrollbar for Firefox */
      }
      
      .options-bar::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome/Safari */
      }
      
      /* Make option buttons more touch-friendly */
      .option-button {
        padding: 8px 14px;
        font-size: 0.95rem;
      }
      
      /* Adjust logo size for mobile */
      .header-logo {
        height: 35px;
      }

      main {
        height: calc(100vh - var(--header-height) - 120px);
        margin-bottom: 160px; /* Adjusted for input container */
      }

      /* Fix for input container */
      .input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom, 1rem); /* iOS safe area support */
      }
    }

    /* Additional adjustments for very small screens */
    @media (max-width: 480px) {
      .header-center {
        font-size: 1rem;
      }
      
      .option-button {
        padding: 6px 10px;
        font-size: 0.85rem;
      }
      
      .message {
        max-width: 95%;
      }
      
      /* Further reduce logo size for very small screens */
      .header-logo {
        height: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container" id="app-container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Chat History</h2>
        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Toggle Sidebar"><i class="fas fa-bars"></i></button>
      </div>
      <button class="new-chat-btn" id="new-chat-btn"><i class="fas fa-plus"></i> New Chat</button>
      <ul class="chat-history-list" id="chat-history-list">
      </ul>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="main-content" id="main-content">
      <header>
        <div class="header-left">
          <button class="header-sidebar-toggle-btn" id="header-sidebar-toggle-btn" title="Toggle Sidebar"><i class="fas fa-bars"></i></button>
          <button class="menu-toggle" id="menu-toggle" title="Open Chat History"><i class="fas fa-bars"></i></button>
        </div>
        <div class="header-center">
          <img src="../logos/logoheaderAi.png" alt="Classmate AI Logo" class="header-logo">
          <span id="chat-title-static">CLASSMATE AI</span>
        </div>
        <div class="header-right">
          <!-- Placeholder for future header elements like theme toggle -->
        </div>
      </header>
      <main>
        <div class="chat-container" id="chat-container">
        </div>
        <div class="loading-indicator" id="loading-indicator">
          <span></span><span></span><span></span>
        </div>
      </main>
      <div class="input-container">
        <!-- Options bar moved above input wrapper -->
        <div class="options-bar">
          <button id="todo-list-option" class="option-button"><i class="fas fa-list-check"></i> To-Do List</button>
          <button id="interviewer-option" class="option-button"><i class="fas fa-user-tie"></i> Mock Interviewer</button>
        </div>
        <div class="input-wrapper">
          <textarea id="user-input" placeholder="Ask ClassMate" rows="1"></textarea>
          <div class="input-buttons">
            <button id="mic-button" class="input-button" title="Speak"><i class="fas fa-microphone"></i></button>
            <button id="send-button" class="input-button" title="Send Message"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const micButton = document.getElementById("mic-button");
    const loadingIndicator = document.getElementById("loading-indicator");
    const appContainer = document.getElementById("app-container");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebar-overlay");
    const menuToggle = document.getElementById("menu-toggle"); 
    const sidebarToggleBtn = document.getElementById("sidebar-toggle-btn");
    const headerSidebarToggleBtn = document.getElementById("header-sidebar-toggle-btn");
    const newChatBtn = document.getElementById("new-chat-btn");
    const chatHistoryList = document.getElementById("chat-history-list");
    const mainContent = document.getElementById("main-content");
    const todoListOption = document.getElementById("todo-list-option");
    const interviewerOption = document.getElementById("interviewer-option");
    const serverUrl = "https://classmate1-ffw7.onrender.com"; // Update with your server URL

    let currentChatId = null;
    let allChats = {}; 
    let recognition = null;
    let isRecording = false;
    let isToDoListModeActive = false;

    let promptBase = `You are ClassMate, a smart academic assistant for students.
    You help them manage goals, generate to-do lists, explain concepts with code and tables, and reply in an organized, friendly format.
    
    For all queries, respond as a helpful academic assistant.`;

    let todoListPrompt = `IMPORTANT INSTRUCTION: You MUST generate the actual content for a to-do list or plan. Then, format YOUR GENERATED CONTENT according to the following multi-level structure. Fill in all placeholders like [Generated Goal Name] and [Generated Task X.Y] with specific, relevant information based on the user's request. Do not just show an empty template. Your entire response must be:

Goal: [Generated Goal Name based on user query, e.g., Learn Python Basics]
Phase 1: [e.g., Foundational Concepts]
- [Generated Task 1.1, e.g., Understand Python syntax and indentation]
- [Generated Task 1.2, e.g., Learn variables and data types (integers, floats, strings, booleans)]
- [Generated Task 1.3, e.g., Practice with print() and input() functions]
...
Phase 2: [e.g., Data Structures and Control Flow]
- [Generated Task 2.1, e.g., Learn and use lists, tuples, sets, and dictionaries]
- [Generated Task 2.2, e.g., Master string methods and slicing]
- [Generated Task 2.3, e.g., Understand and implement for and while loops]
...
(Add more phases and tasks as appropriate for the user's request)

Remember to break your goals into phases and tasks.`;

    // Function to check if we're in mobile/tablet view
    function isMobileView() {
        return window.innerWidth <= 1024;
    }

    // Sidebar toggle functionality
    function toggleSidebar() {
        if (isMobileView()) {
            // In mobile view, toggle the open class
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                sidebarOverlay.style.display = 'block';
            } else {
                sidebarOverlay.style.display = 'none';
            }
        } else {
            // In desktop view, toggle the collapsed class
            sidebar.classList.toggle('collapsed');
            appContainer.classList.toggle('sidebar-hidden');
            localStorage.setItem('sidebarState_ClassMate', sidebar.classList.contains('collapsed') ? 'collapsed' : 'open');
        }
        
        // Update toggle button visibility
        updateToggleButtonVisibility();
    }
    
    // Attach click handlers to both toggle buttons
    sidebarToggleBtn.addEventListener('click', toggleSidebar);
    headerSidebarToggleBtn.addEventListener('click', toggleSidebar);
    menuToggle.addEventListener('click', toggleSidebar);

    // Update toggle button visibility based on sidebar state and viewport
    function updateToggleButtonVisibility() {
        if (isMobileView()) {
            // Mobile view
            menuToggle.style.display = 'block';
            headerSidebarToggleBtn.style.display = 'none';
        } else {
            // Desktop view
            menuToggle.style.display = 'none';
            headerSidebarToggleBtn.style.display = sidebar.classList.contains('collapsed') ? 'block' : 'none';
        }
    }

    // Close mobile sidebar when clicking overlay
    sidebarOverlay.addEventListener('click', () => {
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        }
    });

    // Close mobile sidebar when clicking outside
    document.addEventListener('click', (event) => {
        if (isMobileView() && 
            sidebar.classList.contains('open') && 
            !sidebar.contains(event.target) && 
            !menuToggle.contains(event.target)) {
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        }
    });

    userInput.addEventListener('input', () => {
        userInput.style.height = 'auto';
        const lineHeight = parseFloat(getComputedStyle(userInput).lineHeight);
        const maxHeight = lineHeight * 3;
        const scrollHeight = userInput.scrollHeight;
        userInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
        sendButton.disabled = userInput.value.trim() === '';
    });

    // To-Do List mode toggle
    todoListOption.addEventListener('click', () => {
        isToDoListModeActive = !isToDoListModeActive;
        todoListOption.classList.toggle('active', isToDoListModeActive);
    });

    // Mock Interviewer navigation
    interviewerOption.addEventListener('click', () => {
        window.location.href = 'mock_interviewer_speech.html';
    });

    function copyTextToClipboard(text, buttonElement, successIconClass = 'fa-check', originalIconClass = 'fa-copy') {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = `<i class="fas ${successIconClass}"></i> Copied!`;
            setTimeout(() => {
                buttonElement.innerHTML = originalHTML;
            }, 2000);
        }).catch(err => {
            console.error("Failed to copy text:", err);
            const originalHTML = buttonElement.innerHTML;
            buttonElement.textContent = "Error";
            setTimeout(() => {
                buttonElement.innerHTML = originalHTML;
            }, 2000);
        });
    }

    function appendMessage(text, sender, rawHtml = false) {
        const msgWrapper = document.createElement("div");
        msgWrapper.className = `message ${sender}`;
        const chatContentDiv = document.createElement('div');
        chatContentDiv.className = 'chat-content';

        if (sender === 'user') {
            const p = document.createElement('p');
            p.textContent = text;
            chatContentDiv.appendChild(p);
        } else if (rawHtml) {
             chatContentDiv.innerHTML = text;
        } else {
            const codeBlockRegex = /```([a-zA-Z0-9]*)\n?([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;
            let hasCodeBlock = false;

            while ((match = codeBlockRegex.exec(text)) !== null) {
                hasCodeBlock = true;
                if (match.index > lastIndex) {
                    const precedingText = text.substring(lastIndex, match.index).trim();
                    if (precedingText) {
                        const textDiv = document.createElement('div');
                        textDiv.innerHTML = marked.parse(precedingText);
                        chatContentDiv.appendChild(textDiv);
                    }
                }
                const language = match[1] || 'plaintext';
                const code = match[2].trim();
                const pre = document.createElement('pre');
                const codeEl = document.createElement('code');
                codeEl.className = `language-${language}`;
                codeEl.textContent = code;
                pre.appendChild(codeEl);

                const copyBtnContainer = document.createElement('div');
                copyBtnContainer.className = 'code-copy-btn-container';
                const codeCopyBtn = document.createElement('button');
                codeCopyBtn.className = 'copy-btn';
                codeCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Code';
                codeCopyBtn.title = 'Copy code block';
                codeCopyBtn.onclick = () => copyTextToClipboard(code, codeCopyBtn);
                copyBtnContainer.appendChild(codeCopyBtn);
                pre.appendChild(copyBtnContainer);
                chatContentDiv.appendChild(pre);
                hljs.highlightElement(codeEl);
                lastIndex = codeBlockRegex.lastIndex;
            }

            if (lastIndex < text.length) {
                const remainingText = text.substring(lastIndex).trim();
                if (remainingText) {
                    const textDiv = document.createElement('div');
                    textDiv.innerHTML = marked.parse(remainingText);
                    chatContentDiv.appendChild(textDiv);
                }
            }
            
            if (!hasCodeBlock && lastIndex === 0) { 
                 chatContentDiv.innerHTML = marked.parse(text);
            }

            const botTextContent = Array.from(chatContentDiv.childNodes)
                .filter(node => node.nodeName !== 'PRE')
                .map(node => (node.textContent || node.innerText || '').trim())
                .filter(txt => txt.length > 0)
                .join('\n').trim();
            
            if (botTextContent) {
                const universalCopyBtnContainer = document.createElement('div');
                universalCopyBtnContainer.className = 'reply-copy-btn-container';
                const universalCopyBtn = document.createElement('button');
                universalCopyBtn.className = 'copy-btn bot-reply-copy-btn';
                universalCopyBtn.innerHTML = '<i class="fas fa-clipboard"></i>';
                universalCopyBtn.title = 'Copy AI reply text';
                universalCopyBtn.onclick = (e) => {
                    e.stopPropagation();
                    copyTextToClipboard(botTextContent, universalCopyBtn, 'fa-check', 'fa-clipboard');
                };
                universalCopyBtnContainer.appendChild(universalCopyBtn);
                msgWrapper.appendChild(universalCopyBtnContainer);
            }
        }

        msgWrapper.appendChild(chatContentDiv);
        chatContainer.appendChild(msgWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return msgWrapper;
    }

    async function sendMessageAPI(userMessageContent) {
        if (!currentChatId || !allChats[currentChatId]) {
            console.error("sendMessageAPI: No active chat session.");
            appendMessage("Error: No active chat. Please start a new chat.", "bot", true);
            return;
        }
        
        allChats[currentChatId].messages.push({ role: "user", parts: userMessageContent });
        updateChatTitleIfNeeded(currentChatId, userMessageContent);
        saveChatsToLocalStorage();

        sendButton.disabled = true;
        micButton.disabled = true;
        loadingIndicator.style.display = 'flex';

        try {
            const conversationHistoryForAPI = allChats[currentChatId].messages.map(m => `${m.role === "user" ? 'User' : 'AI'}: ${m.parts}`).join('\n');
            let fullPrompt = promptBase;
            
            // Add to-do list specific instructions ONLY if the mode is active
            if (isToDoListModeActive) {
                fullPrompt = todoListPrompt;
            }
            
            fullPrompt += `\n\nConversation History:\n${conversationHistoryForAPI}`;
            
            const response = await fetch(serverUrl + "/api/chat", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: fullPrompt })
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            const reply = data.reply || "Sorry, I couldn't get a response.";

            appendMessage(reply, "bot");
            allChats[currentChatId].messages.push({ role: "ai", parts: reply });
            saveChatsToLocalStorage();
        } catch (err) {
            appendMessage(`Error: ${err.message || "Failed to connect to the server."}`, "bot", true);
            console.error("API Error:", err);
        } finally {
            sendButton.disabled = userInput.value.trim() === '';
            micButton.disabled = false;
            loadingIndicator.style.display = 'none';
            userInput.focus();
        }
    }

    function handleSendMessage() {
        const userText = userInput.value.trim();
        if (!userText) return;
        appendMessage(userText, "user");
        sendMessageAPI(userText);
        userInput.value = "";
        userInput.style.height = 'auto';
        userInput.dispatchEvent(new Event('input')); 
    }

    sendButton.addEventListener('click', handleSendMessage);
    userInput.addEventListener("keydown", (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    });

    // Initialize Web Speech API for voice input if available
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            userInput.dispatchEvent(new Event('input'));
        };

        recognition.onend = () => {
            isRecording = false;
            micButton.classList.remove('recording');
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            isRecording = false;
            micButton.classList.remove('recording');
        };

        micButton.addEventListener('click', () => {
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                micButton.classList.remove('recording');
            } else {
                recognition.start();
                isRecording = true;
                micButton.classList.add('recording');
            }
        });
    } else {
        micButton.style.display = 'none';
    }

    // Chat history management
    function createNewChat() {
        const chatId = Date.now().toString();
        allChats[chatId] = {
            id: chatId,
            title: "New Chat",
            messages: []
        };
        currentChatId = chatId;
        saveChatsToLocalStorage();
        updateChatHistoryUI();
        chatContainer.innerHTML = '';
        if (isMobileView()) {
            toggleSidebar(); // Close sidebar on mobile after creating new chat
        }
    }

    function updateChatTitleIfNeeded(chatId, userMessage) {
        const chat = allChats[chatId];
        if (chat && chat.title === "New Chat" && chat.messages.length === 0) {
            // This is the first message in a new chat, use it to generate a title
            const titlePreview = userMessage.substring(0, 30) + (userMessage.length > 30 ? "..." : "");
            chat.title = titlePreview;
            updateChatHistoryUI();
        }
    }

    function saveChatsToLocalStorage() {
        localStorage.setItem('chats_ClassMate', JSON.stringify(allChats));
        localStorage.setItem('currentChatId_ClassMate', currentChatId);
    }

    function loadChatsFromLocalStorage() {
        const savedChats = localStorage.getItem('chats_ClassMate');
        const savedCurrentChatId = localStorage.getItem('currentChatId_ClassMate');
        
        if (savedChats) {
            allChats = JSON.parse(savedChats);
        }
        
        if (savedCurrentChatId && allChats[savedCurrentChatId]) {
            currentChatId = savedCurrentChatId;
            loadChat(currentChatId);
        } else if (Object.keys(allChats).length > 0) {
            // Load the most recent chat if current chat is not found
            currentChatId = Object.keys(allChats).sort().reverse()[0];
            loadChat(currentChatId);
        } else {
            // No chats found, create a new one
            createNewChat();
        }
    }

    function loadChat(chatId) {
        if (!allChats[chatId]) return;
        
        currentChatId = chatId;
        chatContainer.innerHTML = '';
        
        // Load messages
        const messages = allChats[chatId].messages;
        messages.forEach(msg => {
            appendMessage(msg.parts, msg.role === "user" ? "user" : "bot");
        });
        
        // Update UI to show active chat
        updateChatHistoryUI();
        
        // Save current chat ID to localStorage
        localStorage.setItem('currentChatId_ClassMate', currentChatId);
    }

    function updateChatHistoryUI() {
        chatHistoryList.innerHTML = '';
        
        // Sort chats by ID (timestamp) in descending order
        const sortedChatIds = Object.keys(allChats).sort((a, b) => parseInt(b) - parseInt(a));
        
        sortedChatIds.forEach(chatId => {
            const chat = allChats[chatId];
            const li = document.createElement('li');
            li.className = chatId === currentChatId ? 'active' : '';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'chat-item-title';
            titleSpan.textContent = chat.title;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'chat-item-actions';
            
            const renameBtn = document.createElement('button');
            renameBtn.className = 'rename-chat-btn';
            renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
            renameBtn.title = 'Rename chat';
            renameBtn.onclick = (e) => {
                e.stopPropagation();
                const newTitle = prompt('Enter new chat title:', chat.title);
                if (newTitle && newTitle.trim()) {
                    chat.title = newTitle.trim();
                    saveChatsToLocalStorage();
                    updateChatHistoryUI();
                }
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-chat-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Delete chat';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this chat?')) {
                    delete allChats[chatId];
                    saveChatsToLocalStorage();
                    
                    if (chatId === currentChatId) {
                        // If we deleted the current chat, load another one or create new
                        const remainingChatIds = Object.keys(allChats);
                        if (remainingChatIds.length > 0) {
                            loadChat(remainingChatIds[0]);
                        } else {
                            createNewChat();
                        }
                    } else {
                        updateChatHistoryUI();
                    }
                }
            };
            
            actionsDiv.appendChild(renameBtn);
            actionsDiv.appendChild(deleteBtn);
            
            li.appendChild(titleSpan);
            li.appendChild(actionsDiv);
            
            li.addEventListener('click', () => {
                if (chatId !== currentChatId) {
                    loadChat(chatId);
                }
                if (isMobileView()) {
                    toggleSidebar(); // Close sidebar on mobile after selecting chat
                }
            });
            
            chatHistoryList.appendChild(li);
        });
    }

    newChatBtn.addEventListener('click', createNewChat);

    // Initialize the app
    window.addEventListener('load', () => {
        loadChatsFromLocalStorage();
        
        // Check if we should start with collapsed sidebar (desktop only)
        const savedSidebarState = localStorage.getItem('sidebarState_ClassMate');
        if (!isMobileView() && savedSidebarState === 'collapsed') {
            sidebar.classList.add('collapsed');
            appContainer.classList.add('sidebar-hidden');
        }
        
        // Update toggle button visibility
        updateToggleButtonVisibility();
        
        // Set initial button state
        sendButton.disabled = true;
        
        // Set initial input height
        userInput.dispatchEvent(new Event('input'));
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        updateToggleButtonVisibility();
        
        // If transitioning from mobile to desktop view, ensure proper sidebar state
        if (!isMobileView()) {
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
            
            // Restore saved desktop sidebar state
            const savedSidebarState = localStorage.getItem('sidebarState_ClassMate');
            if (savedSidebarState === 'collapsed') {
                sidebar.classList.add('collapsed');
                appContainer.classList.add('sidebar-hidden');
            } else {
                sidebar.classList.remove('collapsed');
                appContainer.classList.remove('sidebar-hidden');
            }
        }
    });
  </script>
</body>
</html>